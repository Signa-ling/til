# Sub Agents

## 概要

v1.0.60 より、特定の種類のタスクを処理するためのエージェントを作成できるようになった。これをサブエージェントという。

今までは1つのエージェントに対して、「テスト書いて」、「リファクタリングして」というふうに呼び出していた。

これに対してサブエージェントを用いることで1つのエージェントの中で「テストはテスト用のエージェントに書いてもらう」、「リファクタリングはリファクタリング用のエージェントに行ってもらう」という動かし方ができる

これによるメリットは

- コンテキストの分割
  - 今までは1つのエージェントでそれらを行っていたため、コンテキスト量が増える傾向にあった
    - = 最初の方に指示した内容が忘れられてしまうというデメリットに直結
  - 分割することでメインエージェントのコンテキスト汚染を防げるようになり、忘却を防止しやすくなった
- 専門性の向上
  - 特定タスクに特化したプロンプトを持つことが出来る
  - つまり、特定ドメインへの調整が行いやすく、タスクの成功率向上にも繋がる
- 再利用性
  - 作成したエージェントはユーザーあるいはプロジェクト単位で共有できる
  - つまり、従来の command とかと同じ要領で扱うことができる
- 権限の分離
  - MCP やツールの権限をエージェントごとに設定でき、セキュリティの向上につながる

## エージェントの作成

最終的にこういう形式の Markdown が作られる

```md
---
name: agent-name
description: サブエージェントの説明
tools: どのような tools の使用を許可するか
model: どのモデルで実行されるか
color: どのサブエージェントを呼び出したかを視覚的に識別できるようにする色
---

実際の指示部分
```

作成フローは以下の通り

- claude 上で `/agents` コマンドを実行
- プロジェクト or ユーザーレベルでの作成選択: 以下の形式で作られる
 - プロジェクト: `project/.claude/agents/xx.md`
 - ユーザー: `~/.claude/agents/xx.md`
- 作成方法の選択
  - Generate with Claude: ユーザーが入力したプロンプトから Claude が system prompt, description を作成
  - Manual configuration: 自分で systemp prompt, description を入力して作成
- 使用可能なルールの選択
  - デフォルトは親セッションで使用中のツールが引き継がれる
- 色の選択
  - サブエージェントの視覚的な識別を容易にするための設定

## サブエージェントの管理

`/agents` か直接 `/agents/xx.md` をいじればよい

公式の推奨は `/agents` を利用することらしいが、プロンプトをいじる時は markdown ファイルを直接弄ったほうが良さそうに思える

## 使い方

例えば以下のようなエージェントを用意したとする（Anthropic 公式より引用）

```md
---
name: code-reviewer
description: 専門的なコードレビュースペシャリスト。品質、セキュリティ、保守性のためにコードを積極的にレビューします。コードを書いたり変更した直後に使用してください。
tools: Read, Grep, Glob, Bash
---

あなたは高いコード品質とセキュリティ基準を確保するシニアコードレビューアーです。

呼び出された時：
1. git diffを実行して最近の変更を確認
2. 変更されたファイルに焦点を当てる
3. すぐにレビューを開始

レビューチェックリスト：
- コードがシンプルで読みやすい
- 関数と変数が適切に命名されている
- 重複したコードがない
- 適切なエラーハンドリング
- 秘密情報やAPIキーが露出していない
- 入力検証が実装されている
- 良いテストカバレッジ
- パフォーマンスの考慮事項が対処されている

優先度別にフィードバックを提供：
- 重要な問題（修正必須）
- 警告（修正すべき）
- 提案（改善を検討）

問題の修正方法の具体例を含めてください。
```

呼び出し方は2種類ある

1. 自動委任: リクエストの内のタスクの説明や、サブエージェントの description, 現在のコンテキストと利用可能なツールを元によしなに呼んでもらう
2. 明示的に呼ぶ: claude 上で `code-reviewerサブエージェントに最近の変更を確認してもらってください` のようにして呼び出す

特に自動委任について、積極的にサブエージェントを使用してほしい場合は、 `description` に「積極的に使用」や「必ず使用」といったフレーズを含めると良いとのこと

## 感想

今まで `/command` としていた内容はある程度サブエージェント化して良さそうというか、むしろ `/command` にどういうものを残す / 今後書いていけばいいのかがちょっと分からなくなりつつある。

`/command` にはより小さい粒度で実行できるものを詰め込み、それらを組み合わせることでサブエージェントを組んでいけばいいのかな。

## 参考

- [サブエージェント - Anthropic](https://docs.anthropic.com/ja/docs/claude-code/sub-agents)
- [Claude Code でカスタムサブエージェントを作成する](https://azukiazusa.dev/blog/create-custom-sub-agent-in-claude-code/)
